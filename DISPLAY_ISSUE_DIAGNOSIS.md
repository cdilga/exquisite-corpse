# Display Issue Diagnosis

## Problem Summary

The Exquisite Corpse game page is displaying JavaScript source code as rendered HTML content instead of executing it. This causes:

- Template literal syntax (`${...}`) to appear visually on the page
- Function code and logic to be rendered as text
- Multiple `<body>` tags in the HTML response
- Broken game functionality

## Example of Issue

**What the user sees:**
```
$(currentStory.map((entry, index) => `
${index + 1}. ${entry.playerName}  Round ${entry.roundNumber || 1}
${entry.sentence}
`).join(""))
```

**What should render:**
```
1. Alice
Once upon a time there was a developer.

2. Bob
He loved writing code.
```

## Root Cause Analysis

### Architecture Issue

The entire Exquisite Corpse page is generated by a single function (`getHomePage()` in `src/pages/home.js`) that returns one giant template literal string:

```javascript
export function getHomePage() {
  const html = `<!DOCTYPE html>
<html>
<head>...</head>
<body>
  <!-- HTML content -->
  <script>
    // ALL JavaScript code here, embedded in the template literal
    function displayStory(story) {
      elements.storyContainer.innerHTML = story.map((entry, index) => \`
        <div>...${index}...</div>
      \`).join('');
    }
  </script>
</body>
</html>`;
  return html;
}
```

### The Escaping Problem

When you have a template literal containing another template literal, you must escape the inner backticks:

- **Outer template literal:** Lines 2-1179 (the entire HTML document)
- **Inner template literals:** Inside JavaScript functions (lines 907-916, 1085-1094, etc.)
- **Escaping:** Inner backticks are written as `\`` to avoid prematurely closing the outer template literal

### Expected Behavior

When the outer template literal is evaluated in Node.js on the server, the escape sequence `\`` should be converted to a single backtick, resulting in:

```javascript
// In the resulting HTML string sent to the browser:
elements.storyContainer.innerHTML = story.map((entry, index) => `
  <div>...</div>
`).join('');
```

This is valid JavaScript that the browser's JavaScript engine should recognize and execute.

### Actual Behavior

Instead of the above, the browser is:
1. Receiving HTML with JavaScript code that doesn't execute
2. The template literal syntax appears as rendered text on the page
3. Dynamic content from `${...}` expressions appears literally instead of being evaluated

## Evidence from Tests

The E2E test `tests/e2e/display-debug.spec.js` confirms:

```
❌ FAIL: Page contains "${" in rendered text
✗ Page contains template literal syntax: ${new Date().toLocaleDateString()}
✗ Page contains function code patterns like: .join("")
```

## Hypothesis

There are several possible causes:

1. **Escape Sequence Not Working:**
   The `\`` escape sequence may not be working as expected in this context, leaving literal backslashes in the output

2. **HTML Structure Breaking:**
   The presence of two `<body>` tags suggests the HTML structure is malformed, possibly causing the browser to parse it incorrectly

3. **Script Block Not Recognized:**
   The browser may not recognize the `<script>` block properly due to the malformed HTML structure

4. **Content Security Policy:**
   If CSP is restricting inline scripts, the JavaScript may not execute (though this usually doesn't render the code as text)

## Files Involved

- **Main file:** `src/pages/home.js` (1182 lines, all one template literal)
  - Problem lines:
    - Line 146: First `<body>` tag (main HTML)
    - Line 354: Opening `<script>` tag
    - Lines 905-919: `displayStory()` function with escaped backticks
    - Lines 1064-1110: `formatStoryAsHTML()` function (with inner template literal)
    - Line 1176: Closing `</script>` tag
    - Line 1079: Second `<body>` tag (inside formatStoryAsHTML's return statement)

- **Affected functions:**
  - `displayStory()`: Uses escaped backticks for template literal
  - `formatStoryAsHTML()`: Returns string with HTML including body tag and template literals
  - All other functions using template literals

- **Test file:** `tests/e2e/display-debug.spec.js` (reproduces issue)

## Reproduction Steps

1. Start dev server: `npm run dev`
2. Navigate to http://localhost:8787/
3. Check page source or use curl:
   ```bash
   curl http://localhost:8787/ | grep "\${"
   # Output: Should be empty, but shows template syntax if broken
   ```
4. Run E2E test:
   ```bash
   npm run test:e2e -- tests/e2e/display-debug.spec.js
   ```

## Potential Solutions

### Solution 1: Fix Escape Sequences
Verify that `\`` escape sequences are being processed correctly by Node.js template literals.

### Solution 2: Refactor to Use String Concatenation
Instead of nested template literals, use string concatenation for the JavaScript code:

```javascript
const html = '<!DOCTYPE html>...' +
  '<script>' +
  'function displayStory(story) {' +
  '  elements.storyContainer.innerHTML = story.map((entry, index) => `' +
  '    <div>${index + 1}</div>' +
  '  `).join("");' +
  '}' +
  '</script>' +
  '...';
```

### Solution 3: Extract JavaScript to Separate Module
Move JavaScript code out of the template literal:

```javascript
import { gameScripts } from './game-scripts.js';

export function getHomePage() {
  const html = `<!DOCTYPE html>
    <body>
    <script>${gameScripts}</script>
    </body>
  </html>`;
}
```

### Solution 4: Use Raw Strings
Consider using `String.raw` or other techniques to avoid escaping issues.

## Status

- **Issue Identified:** ✅ Yes, confirmed by E2E tests
- **Root Cause Understood:** ✅ Template literal nesting with escaping
- **Reproduction Test Created:** ✅ display-debug.spec.js
- **Fix Implemented:** ❌ Pending
- **Tested:** ❌ Pending

## Next Steps

1. **Investigation:**
   - Check if `\`` is actually being converted to `` ` `` in the served HTML
   - Use Playwright to inspect the actual HTML received by the browser
   - Check browser console for JavaScript errors

2. **Implementation:**
   - Choose a solution (1-4 above)
   - Implement fix
   - Run tests to verify

3. **Validation:**
   - Run `npm run test:e2e` to confirm fix
   - Manually test game flow end-to-end
   - Verify no regressions in other features
